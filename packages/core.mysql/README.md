<h1 align="center">@thermopylae/core.mysql</h1>
<p>
  <img alt="Version" src="https://img.shields.io/badge/version-0.0.1-blue.svg?cacheSeconds=2592000" />
  <img alt="Node Version" src="https://img.shields.io/badge/node-%3E%3D16-blue.svg"/>
<a href="https://marinrusu1997.github.io/thermopylae/core.mysql/index.html" target="_blank">
  <img alt="Documentation" src="https://img.shields.io/badge/documentation-yes-brightgreen.svg" />
</a>
<a href="https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE" target="_blank">
  <img alt="License: ISC" src="https://img.shields.io/badge/License-MIT-yellow.svg" />
</a>
</p>

> MySQL client.

## Install

```sh
npm install @thermopylae/core.mysql
```

## Description
This package contains client for MySQL Server.
It uses [mysql2](https://www.npmjs.com/package/mysql2) npm package as underlying implementation. <br/>
[MySQLClient][mysql-client-link] allows you to establish pooled connections or pool cluster connections.
Write & Read pools are abstracted regardless of pooled or pool cluster connections.

## Usage
Package exports a singleton of [MySQLClient][mysql-client-link] class, called *MySqlClientInstance*, which needs to be configured before being used.
After that you can create connections and perform queries. <br/>
Let's take a look at the following example which demonstrates how the package can be used.
```typescript
import {
    MySqlClientInstance,
    QueryType,
    DebuggableEventType,
    ResultSetHeader,
    RowDataPacket,
    initLogger as initCoreMysqlLogger 
} from '@thermopylae/core.mysql';
import { LoggerManagerInstance, OutputFormat } from '@thermopylae/core.logger';

(async function main() {
    /* Firstly init logging system */
    LoggerManagerInstance.formatting.setDefaultFormattingOrder(OutputFormat.PRINTF);
    LoggerManagerInstance.console.createTransport({ level: 'info' });
    initCoreMysqlLogger();
    
    /* Configure MySQL */
    MySqlClientInstance.init({
        pool: {
            host: '127.0.0.1',
            port: 3306,
            user: 'your-user',
            password: 'your-password',
            database: 'your-database'
        },
        /*
            // alternative to `pool` is `poolCluster` option
            poolCluster: {
                nodes: {
                    MASTER: { host: '127.0.0.1', port: 3306 },
                    SLAVE: { host: '127.0.0.1', port: 3307 }
                }
            }
         */
        sessionVariablesQueries: ["SET @id = 'A';"],
        attachDebugListeners: new Set<DebuggableEventType>(['connection', 'enqueue'])
    });
    
    /* Perform queries  */
    let accountId: string;
    let connection = await MySqlClientInstance.getConnection(QueryType.WRITE);
    
    try {
        const [results] = await connection.execute<ResultSetHeader>(
            `INSERT INTO Account (username, passwordHash, email) VALUES (?, ?, ${MySqlClientInstance.escape('email@email.com')});`,
            ['username', 'hash']
        );

        accountId = String(results.insertId);
    } finally {
        connection.release(); // VERY IMPORTANT! Connection needs to be released
    }

    connection = await MySqlClientInstance.getConnection(QueryType.READ);
    try {
        const [results] = await connection.query<RowDataPacket[]>(`SELECT * FROM Account WHERE id=${accountId};`);

        if (results.length === 1) {
            console.log(`Account found: ${JSON.stringify(results[0])}`);
        }
    } finally {
        connection.release(); // VERY IMPORTANT! Connection needs to be released
    }
    
    /* Shutdown */
    await MySqlClientInstance.shutdown();
})();
```

## API Reference
API documentation is available [here][api-doc-link].

It can also be generated by issuing the following commands:
```shell
git clone git@github.com:marinrusu1997/thermopylae.git
cd thermopylae
yarn install
yarn workspace @thermopylae/core.mysql run doc
```

## Author
üë§ **Rusu Marin**

* GitHub: [@marinrusu1997](https://github.com/marinrusu1997)
* Email: [dimarusu2000@gmail.com](mailto:dimarusu2000@gmail.com)
* LinkedIn: [@marinrusu1997](https://www.linkedin.com/in/rusu-marin-1638b0156/)

## üìù License
Copyright ¬© 2021 [Rusu Marin](https://github.com/marinrusu1997). <br/>
This project is [MIT](https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE) licensed.

[api-doc-link]: https://marinrusu1997.github.io/thermopylae/core.mysql/index.html
[mysql-client-link]: https://marinrusu1997.github.io/thermopylae/core.mysql/classes/client.mysqlclient.html
