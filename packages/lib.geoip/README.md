<h1 align="center">@thermopylae/lib.geoip</h1>
<p>
  <img alt="Version" src="https://img.shields.io/badge/version-0.0.1-blue.svg?cacheSeconds=2592000" />
  <img alt="Node Version" src="https://img.shields.io/badge/node-%3E%3D16-blue.svg"/>
<a href="https://marinrusu1997.github.io/thermopylae/lib.geoip/index.html" target="_blank">
  <img alt="Documentation" src="https://img.shields.io/badge/documentation-yes-brightgreen.svg" />
</a>
<a href="https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE" target="_blank">
  <img alt="License: MIT" src="https://img.shields.io/badge/License-MIT-yellow.svg" />
</a>
</p>

> Geolocation based on ip address.

## Install

```sh
npm install @thermopylae/lib.geoip
```

### Postinstall
After installing this library, please consider to [update geoip-lite local database](https://www.npmjs.com/package/geoip-lite#built-in-updater).

## Description
This package allows you to retrieve location of the ip by using [GeoIpLocator][geo-ip-locator-link]. <br/>
This class allows you to register a set of repositories from where location of the ip can be retrieved.
When location is requested, it will load balance request to one of these repositories in order to retrieve it.
Three repositories are implemented by default:
* [GeoIpLiteRepository][geoiplite-repository-link]
* [IpLocateRepository][iplocate-repository-link]
* [IpstackRepository][ipstack-repository-link]

You can also create your own repository by implementing [IpLocationsRepository][iplocation-repository-interface-link] interface.

## Usage
```typescript
import {
    GeoIpLocator,
    GeoIpLiteRepository,
    IpstackRepository,
    IpstackSubscriptionPlan
} from '@thermopylae/lib.geoip';

(async function main() {
    const geoip = new GeoIpLocator([
        new GeoIpLiteRepository(1),
        new IpstackRepository({
            apiKey: 'IPSTACK_ACCESS_KEY',
            lang: 'en',
            plan: IpstackSubscriptionPlan.FREE,
            weight: 2,
            hooks: {
                onIpRetrievalError(err) {
                    console.error('Failed to retrieve location from ipstack ', err);
                }
            }
        }),
        new IpLocateRepository({
            apiKey: 'IP_LOCATE_ACCESS_KEY',
            weight: 3,
            hooks: {
                onIpRetrievalError(err) {
                    console.error('Failed to retrieve location from iplocate ', err);
                },
                onRateLimitExceeded(rateLimitReset) {
                    console.info('Iplocate Rate limit reset at ', rateLimitReset);
                }
            }
        })
    ]);
    
    // retrieve location from random repository
    const firstLookup = await geoip.locate('8.8.8.8');
    console.log(firstLookup);
    
    // retrieve from same repository again so that location objects are the same
    // you are not required to specify 'repository-id', in this case a random repository will be selected
    // which may provide a location a bit different from the previous one for same ip
    const secondLookup = await geoip.locate('8.8.8.8', firstLookup.REPOSITORY_ID);
    console.log(secondLookup);
})();
```

## API Reference
API documentation is available [here][api-doc-link].

It can also be generated by issuing the following commands:
```shell
git clone git@github.com:marinrusu1997/thermopylae.git
cd thermopylae
yarn install
yarn workspace @thermopylae/lib.geoip run doc
```

## Author
üë§ **Rusu Marin**

* GitHub: [@marinrusu1997](https://github.com/marinrusu1997)
* Email: [dimarusu2000@gmail.com](mailto:dimarusu2000@gmail.com)
* LinkedIn: [@marinrusu1997](https://www.linkedin.com/in/rusu-marin-1638b0156/)

## üìù License
Copyright ¬© 2021 [Rusu Marin](https://github.com/marinrusu1997). <br/>
This project is [MIT](https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE) licensed.

[api-doc-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/index.html
[geo-ip-locator-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/classes/geoip.geoiplocator.html
[geoiplite-repository-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/modules/repository_geoip_lite.html
[iplocate-repository-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/modules/repository_iplocate.html
[ipstack-repository-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/modules/repository_ipstack.html
[iplocation-repository-interface-link]: https://marinrusu1997.github.io/thermopylae/lib.geoip/modules/repository.html
