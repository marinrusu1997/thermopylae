<h1 align="center">@thermopylae/core.redis</h1>
<p>
  <img alt="Version" src="https://img.shields.io/badge/version-0.0.1-blue.svg?cacheSeconds=2592000" />
  <img alt="Node Version" src="https://img.shields.io/badge/node-%3E%3D16-blue.svg"/>
<a href="https://marinrusu1997.github.io/thermopylae/core.redis/index.html" target="_blank">
  <img alt="Documentation" src="https://img.shields.io/badge/documentation-yes-brightgreen.svg" />
</a>
<a href="https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE" target="_blank">
  <img alt="License: ISC" src="https://img.shields.io/badge/License-MIT-yellow.svg" />
</a>
</p>

> Redis client.

## Install
```sh
npm install @thermopylae/core.redis
```

## Description
This package contains [client][redis-client-link] for Redis Server. <br/>
It can maintain up to 3 [types of connections][connection-type-link] to Redis Server.
Each connection represents an instance of [node-redis](https://www.npmjs.com/package/redis) client. <br/>
[Redis Modules](https://redis.io/modules) are also supported. For now, only [Redis JSON][redis-json-module-link] is implemented.

## Usage
Package exports a singleton of [RedisClient][redis-client-link] class, called *RedisClientInstance*, which needs to be configured before being used.
After that you can access connections that were established and work with them. <br/>
Let's take a look at the following example which demonstrates how the package can be used.
```typescript
import { 
    RedisClientInstance, 
    ConnectionType,
    RedisConnectionOptions,
    RedisModule,
    initLogger as initCoreRedisLogger 
} from '@thermopylae/core.redis';
import { LoggerManagerInstance, OutputFormat } from '@thermopylae/core.logger';

(async function main() {
    /* Firstly init logging system */
    LoggerManagerInstance.formatting.setDefaultFormattingOrder(OutputFormat.PRINTF);
    LoggerManagerInstance.console.createTransport({ level: 'info' });
    initCoreRedisLogger();
    
    /* Connect to Redis Server */
    const connectionOptions = {
        host: '127.0.0.1',
        port: 3306,
        password: 'your-password',
        connect_timeout: 10_000,
        max_attempts: 10,
        retry_max_delay: 5_000,
        attachDebugListeners: new Set<DebuggableEventType>(['end', 'reconnecting'])
    } as RedisConnectionOptions;
    
    await RedisClientInstance.connect(
        {
            [ConnectionType.REGULAR]: connectionOptions,
            [ConnectionType.SUBSCRIBER]: connectionOptions
        },
        {
            // add commands for redis json module on connections
            modules: new Set([RedisModule.JSON])
        }
    );
    
    /* Set up Keyspace Notification Events */
    await RedisClientInstance.client.config('SET', 'notify-keyspace-events', 'Kgxe');
    await RedisClientInstance.subscriber.subscribe(`__keyspace@${RedisClientInstance.db}__:KEY`);
    RedisClientInstance.on(ConnectionType.SUBSCRIBER, 'message', (channel, message) => {
        console.log(`Received new message on channel '${channel}': ${message}`);
    });
    
    /* Issue commands (see node-redis documentation for multiple details) */
    await RedisClientInstance.client.set('KEY', 'VALUE', ['EX', 2], 'NX'); // will be logged
    await RedisClientInstance.subscriber.unsubscribe(`__keyspace@${RedisClientInstance.db}__:KEY`);
    await RedisClientInstance.client.del('KEY'); // won't be logged
    
    await RedisClientInstance.client.json_del('JSON_KEY'); // RedisJSON module commands are available too
    
    /* Disconnect */
    await RedisClientInstance.disconnect();
})();
```

## API Reference
API documentation is available [here][api-doc-link].

It can also be generated by issuing the following commands:
```shell
git clone git@github.com:marinrusu1997/thermopylae.git
cd thermopylae
yarn install
yarn workspace @thermopylae/core.redis run doc
```

## Author
üë§ **Rusu Marin**

* GitHub: [@marinrusu1997](https://github.com/marinrusu1997)
* Email: [dimarusu2000@gmail.com](mailto:dimarusu2000@gmail.com)
* LinkedIn: [@marinrusu1997](https://linkedin.com/in/marinrusu1997)

## üìù License
Copyright ¬© 2021 [Rusu Marin](https://github.com/marinrusu1997). <br/>
This project is [MIT](https://github.com/marinrusu1997/thermopylae/blob/master/LICENSE) licensed.

[api-doc-link]: https://marinrusu1997.github.io/thermopylae/core.redis/index.html
[redis-client-link]: https://marinrusu1997.github.io/thermopylae/core.redis/classes/client.redisclient.html
[connection-type-link]: https://marinrusu1997.github.io/thermopylae/core.redis/enums/client.connectiontype.html
[redis-json-module-link]: https://marinrusu1997.github.io/thermopylae/core.redis/interfaces/modules_json.jsonmodulecommands.html
